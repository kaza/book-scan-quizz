<!DOCTYPE html>
<html>
<head>
    <title>Silero VAD in Browser (Mobile-Optimized)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
</head>
<body>
    <button id="startButton">Start VAD</button>
    <div id="result"></div>
    <div id="deviceInfo"></div>

    <script>
        // ... [Previous code remains the same] ...

        async function startVAD() {
            if (!model) {
                await loadModel();
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);

                isRunning = true;
                detectVoiceActivity();
            } catch (error) {
                console.error('Error accessing microphone:', error);
                document.getElementById('result').textContent = 'Error: ' + error.message;
            }
        }

        function detectVoiceActivity() {
            if (!isRunning) return;

            const bufferLength = analyser.fftSize;
            const audioData = new Float32Array(bufferLength);
            analyser.getFloatTimeDomainData(audioData);

            // Preprocess audio data (you may need to adjust this based on model requirements)
            const tensor = new ort.Tensor('float32', audioData, [1, audioData.length]);

            try {
                const feeds = { input: tensor };
                const results = model.run(feeds);
                const output = results.output.data[0];

                document.getElementById('result').textContent = output > 0.5 ? 'Voice Detected' : 'No Voice';
            } catch (error) {
                console.error('Inference error:', error);
                document.getElementById('result').textContent = 'Error: ' + error.message;
            }

            // Adjust the delay based on device performance
            const delay = isMobileDevice() ? 100 : 0;
            setTimeout(() => requestAnimationFrame(detectVoiceActivity), delay);
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Display device info
        function showDeviceInfo() {
            const deviceInfo = document.getElementById('deviceInfo');
            deviceInfo.textContent = `Device: ${isMobileDevice() ? 'Mobile' : 'Desktop'},
                                      UserAgent: ${navigator.userAgent}`;
        }

        document.getElementById('startButton').addEventListener('click', startVAD);

        // Load the model and show device info when the page loads
        loadModel();
        showDeviceInfo();
    </script>
</body>
</html>