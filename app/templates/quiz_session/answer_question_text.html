<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Quiz Question - Book-Scan-Quizz{% endblock %}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css");

        .btn[aria-expanded="true"] .bi-chevron-down {
            transform: rotate(180deg);
        }

        .bi-chevron-down {
            transition: transform 0.3s ease-in-out;
        }

        #tts-speed-value {
            display: inline-block;
            width: 30px;
            text-align: right;
        }

        .progress {
            height: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">Question</h1>

    <!-- Progress bar -->
    <div class="progress mb-4">
        <div class="progress-bar" role="progressbar" style="width: {{ progress_percentage }}%;"
             aria-valuenow="{{ progress_percentage }}" aria-valuemin="0" aria-valuemax="100">
            {{ answered_count }} / {{ total_count }}
        </div>
    </div>

    <p id="question-text" class="lead mb-4">{{ question.question_text }}</p>

    <!-- Mode Toggle Switch -->
    <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" id="mode-toggle" checked>
        <label class="form-check-label" for="mode-toggle">Switch to Audio Mode</label>
    </div>

    <div id="tts-controls" class="mb-4">
        <button class="btn btn-secondary mb-2 d-flex align-items-center justify-content-between w-100" type="button"
                data-bs-toggle="collapse" data-bs-target="#ttsSettings" aria-expanded="false"
                aria-controls="ttsSettings">
            <span>TTS Settings</span>
            <i class="bi bi-chevron-down"></i>
        </button>
        <div class="collapse" id="ttsSettings">
            <div class="card card-body">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="autoReadResults">
                    <label class="form-check-label" for="autoReadResults">
                        Automatically read results aloud
                    </label>
                </div>
                <label for="voice-select" class="form-label">Select Voice:</label>
                <select id="voice-select" class="form-select mb-2">
                    <!-- Voice options will be populated by JavaScript -->
                </select>
                <label for="tts-speed" class="form-label">Speech Speed:</label>
                <input type="range" class="form-range" id="tts-speed" min="0.5" max="3" step="0.1" value="1">
                <span id="tts-speed-value">1x</span>
            </div>
        </div>
    </div>

    <div id="spoken-text-display" class="alert alert-info mt-3" style="display: none;"></div>

    <p class="mb-4">Press and hold the button to start speech recognition.</p>

    <div class="text-center my-4">
        <button id="recordButton" class="btn btn-lg btn-success rounded-circle"
                style="width: 100px; height: 100px;">
            Push to Answer
        </button>
    </div>

    <div id="resultContainer" class="mt-4">
        <h3>Transcribed Text:</h3>
        <p id="resultText"></p>
    </div>

    <div id="processingFeedback" class="text-center my-2" style="display: none;">
        Processing your answer...
    </div>

    <div id="feedbackContainer" class="mt-4" style="display: none;">
        <h3>Feedback:</h3>
        <p id="feedbackText"></p>
    </div>

    <div id="actionButtons" class="text-center mt-4 d-none">
        <button id="nextQuestionButton" class="btn btn-primary">Next Question</button>
    </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/text_to_speech.js') }}"></script>
<script src="{{ url_for('static', filename='js/quiz_session_tts.js') }}"></script>
<script src="{{ url_for('static', filename='js/speech_to_text.js') }}"></script>
<script src="{{ url_for('static', filename='js/quiz_session.js') }}"></script>
<script src="{{ url_for('static', filename='js/mode_switcher.js') }}"></script>
<script>
    // Pass the values directly to JavaScript
    const QUESTION_ID = "{{ question.id }}";
    const SESSION_ID = "{{ session_id }}";

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Text-to-Speech
        TextToSpeech.init();

        // Initialize quiz session TTS functionality
        QuizSessionTTS.init();

        // Initialize speech recognition
        initSpeechRecognition('{{ url_for("quiz_session.evaluate_text") }}', QUESTION_ID, SESSION_ID);

        // Set up the next question URL for the quiz_session.js
        window.nextQuestionUrl = '{{ url_for("quiz_session.answer_question", session_id=session_id) }}';

        // Initialize mode switcher
        initModeSwitcher();
    });
</script>
</body>
</html>